#
# WordPress admin/login stability exclusions (CRS 4.x)
#

# wp-login.php: keep CRS active. (If you later see specific false positives here,
# remove by rule id rather than disabling the engine.)
SecRule REQUEST_URI "@streq /wp-login.php" \
  "id:9003000,phase:1,pass,nolog"

# wp-admin: keep CRS active (remove the old 9003001 DetectionOnly rule entirely)
# If you want an explicit "do nothing" marker:
SecRule REQUEST_URI "@beginsWith /wp-admin/" \
  "id:9003001,phase:1,pass,nolog"

#
# -- WordPress Core Exclusions -----------------------------------------
#

# Allow WordPress heartbeat endpoints (backend quotas, autosave, keepalive)
SecRule REQUEST_URI "@beginsWith /wp-admin/admin-ajax.php" \
  "id:9002000,phase:1,nolog,pass,setvar:tx.crs_exclusions_wordpress=1"

# Allow WordPress Gutenberg JSON API (broad flag, we apply *scoped* ctl rules below)
SecRule REQUEST_URI "@beginsWith /wp-json/" \
  "id:9002001,phase:1,nolog,pass,setvar:tx.crs_exclusions_wordpress=1"

# Classic editor / plugin settings often embed HTML in POST
SecRule REQUEST_URI "@beginsWith /wp-admin/post.php" \
  "id:9002002,phase:1,nolog,pass,setvar:tx.crs_exclusions_wordpress=1"

# Allow WordPress media uploads
SecRule REQUEST_URI "@beginsWith /wp-admin/async-upload.php" \
  "id:9002003,phase:1,nolog,pass,setvar:tx.crs_exclusions_wordpress=1"

# We do not use XML-RPC: block it outright
SecRule REQUEST_URI "@streq /xmlrpc.php" \
  "id:9002020,phase:1,deny,status:403,log,msg:'Blocked WordPress XML-RPC (not in use)'"

#
# -- WordPress admin asset loaders (long query strings) ------------------
#
# These commonly trip 920100 "Invalid HTTP Request Line" due to very long query strings.
# Apply narrowly to load-styles.php and load-scripts.php only.
SecRule REQUEST_URI "@rx ^/wp-admin/load-(?:styles|scripts)\.php$" \
  "id:9002008,phase:1,pass,nolog,ctl:ruleRemoveById=920100"

#
# -- WordPress REST write traffic tuning (Gutenberg editor / autosaves) --
#
# Flag only REST writes to pages/posts. This avoids weakening public read endpoints.
SecRule REQUEST_URI "@rx ^/wp-json/wp/v2/(?:pages|posts)(?:/|$)" \
  "id:9002010,phase:1,pass,nolog,chain"
  SecRule REQUEST_METHOD "@rx ^(?:POST|PUT|PATCH)$" \
    "t:none,setvar:tx.wp_rest_write=1"

# Raise inbound anomaly threshold ONLY for WP REST writes.
# This often prevents score-based blocks (949110) caused by editor HTML/JSON payloads.
SecRule TX:WP_REST_WRITE "@eq 1" \
  "id:9002011,phase:1,pass,nolog,setvar:tx.inbound_anomaly_score_threshold=10"

# If you still see blocks after the threshold bump, suppress the specific noisy rules
# only for REST writes to pages/posts (including autosaves).
# WP editor content commonly triggers XSS checks; suppress these only for REST writes
SecRule TX:WP_REST_WRITE "@eq 1" \
  "id:9002012,phase:1,pass,nolog,ctl:ruleRemoveById=941100,ctl:ruleRemoveById=941160,ctl:ruleRemoveById=941180"

# Gutenberg batch endpoint: treat as REST-write traffic so existing tuning applies
SecRule REQUEST_URI "@beginsWith /wp-json/batch/v1" \
  "id:9002016,phase:1,pass,nolog,chain"
  SecRule REQUEST_METHOD "@rx ^(?:POST|PUT|PATCH)$" \
    "t:none,setvar:tx.wp_rest_write=1"

# If you still get score blocks on REST writes, suppress 942350 for autosaves only
SecRule REQUEST_URI "@rx ^/wp-json/wp/v2/(?:pages|posts)/[0-9]+/autosaves" \
  "id:9002014,phase:1,pass,nolog,chain"
  SecRule REQUEST_METHOD "@rx ^(?:POST|PUT|PATCH)$" \
    "ctl:ruleRemoveById=942350"

#
# -- WP REST header policy (x-http-method-override) ----------------------
#
# If your clients/proxies legitimately send X-HTTP-Method-Override to WP REST,
# Allow X-HTTP-Method-Override only for WP REST writes (editor/autosaves)
SecRule TX:WP_REST_WRITE "@eq 1" \
  "id:9002013,phase:1,pass,nolog,ctl:ruleRemoveById=920450"

#
# -- WordPress Common Plugin Exclusions --------------------------------
#

# Gravity Forms
SecRule REQUEST_URI "@contains /wp-admin/admin-ajax.php?action=gf" \
  "id:9002004,phase:1,nolog,pass,setvar:tx.crs_exclusions_wordpress=1"

# Contact Form 7
SecRule REQUEST_URI "@contains /wp-json/contact-form-7/" \
  "id:9002005,phase:1,nolog,pass,setvar:tx.crs_exclusions_wordpress=1"

# WooCommerce REST API
SecRule REQUEST_URI "@beginsWith /wc-api/" \
  "id:9002006,phase:1,nolog,pass,setvar:tx.crs_exclusions_wordpress=1"

# WooCommerce cart, checkout, sessions
SecRule REQUEST_URI "@beginsWith /?wc-ajax=" \
  "id:9002007,phase:1,nolog,pass,setvar:tx.crs_exclusions_wordpress=1"


#
# -- Drupal Core Exclusions --------------------------------------------
#

# Drupal admin AJAX + form submission
SecRule REQUEST_URI "@beginsWith /core/authorize.php" \
  "id:9002100,phase:1,nolog,pass,setvar:tx.crs_exclusions_drupal=1"

SecRule REQUEST_URI "@beginsWith /core/install.php" \
  "id:9002101,phase:1,nolog,pass,setvar:tx.crs_exclusions_drupal=1"

# Drupal JSON:API endpoints
SecRule REQUEST_URI "@beginsWith /jsonapi/" \
  "id:9002102,phase:1,nolog,pass,setvar:tx.crs_exclusions_drupal=1"

#
# -- Drupal Form API checks (widely used in admin forms) ----------------
#

SecRule ARGS_NAMES "@endsWith _token" \
  "id:9002103,phase:1,nolog,pass,setvar:tx.crs_exclusions_drupal=1"

SecRule REQUEST_URI "@contains /user/login" \
  "id:9002104,phase:1,nolog,pass,setvar:tx.crs_exclusions_drupal=1"

#
# -- Drupal public files (CSS, JS, images) ------------------------------
#
SecRule REQUEST_URI "@beginsWith /sites/default/files/" \
  "id:9003200,phase:1,pass,nolog,ctl:ruleEngine=Off"

#
# -- CiviCRM Exclusions --------------------------------------------------
#

# Main CiviCRM entry point
SecRule REQUEST_URI "@beginsWith /civicrm" \
  "id:9002200,phase:1,nolog,pass,setvar:tx.crs_exclusions_civicrm=1"

# CiviCRM AJAX
SecRule REQUEST_URI "@contains /civicrm/ajax/" \
  "id:9002201,phase:1,nolog,pass,setvar:tx.crs_exclusions_civicrm=1"

# CiviCRM REST endpoints
SecRule REQUEST_URI "@contains /civicrm/rest/" \
  "id:9002202,phase:1,nolog,pass,setvar:tx.crs_exclusions_civicrm=1"

# CiviCRM contribution transactions
SecRule REQUEST_URI "@contains /civicrm/payment/ipn" \
  "id:9002203,phase:1,nolog,pass,setvar:tx.crs_exclusions_civicrm=1"

# CiviCRM WYSIWYG editors, HTML fields, etc.
SecRule ARGS_NAMES "@rx (html|editor|wysiwyg|custom|description)" \
  "id:9002204,phase:1,nolog,pass,setvar:tx.crs_exclusions_civicrm=1"

#
# Verified safe for hardened WordPress/Drupal/CiviCRM hosting
#
# ------------------------------------------------------------------------
# ModSecurity 3.x main configuration (production)
# ------------------------------------------------------------------------

SecRuleEngine ${MODSEC_ENGINE_MODE}

# Request body handling
SecRequestBodyAccess On
SecRequestBodyLimit 100000000
SecRequestBodyNoFilesLimit 100000
SecRequestBodyLimitAction Reject

SecTmpSaveUploadedFiles On
SecTmpDir /tmp/modsec
SecUploadDir /tmp/modsec
SecUploadKeepFiles On

# Anti-virus scanning hook
SecRule FILES_TMPNAMES "@inspectFile /usr/local/bin/clamd-hook.sh" \
    "id:666666,phase:2,log,auditlog,deny,severity:2,t:none,msg:'AV check failed!'"

# Enable content-type based processors
SecRule REQUEST_HEADERS:Content-Type "(?:application(?:/soap\+|/)|text/)xml" \
    "id:200000,phase:1,t:none,pass,nolog,ctl:requestBodyProcessor=XML"

SecRule REQUEST_HEADERS:Content-Type "application/json" \
    "id:200001,phase:1,t:none,pass,nolog,ctl:requestBodyProcessor=JSON"

# Multipart strict mode
SecRule MULTIPART_STRICT_ERROR "!@eq 0" \
    "id:200003,phase:2,t:none,log,deny,status:400"

SecRule MULTIPART_UNMATCHED_BOUNDARY "@eq 1" \
    "id:200004,phase:2,t:none,log,deny,msg:'Multipart parser detected a possible unmatched boundary.'"

# PCRE limits
SecPcreMatchLimit 1000
SecPcreMatchLimitRecursion 1000

SecRule TX:/^MSC_/ "!@streq 0" \
    "id:200005,phase:2,t:none,deny,msg:'ModSecurity internal error flagged: %{MATCHED_VAR_NAME}'"

# Response handling
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

SecTmpDir /tmp/
SecDataDir /tmp/

# Debug logging
SecDebugLog /dev/stderr
SecDebugLogLevel 0

# Audit logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/nginx/modsec_audit.log

# Misc
SecArgumentSeparator "&"
SecCookieFormat 0
SecUnicodeMapFile unicode.mapping 20127
SecStatusEngine Off

# ------------------------------------------------------------------------
# Load OWASP CRS 4.3.0
# ------------------------------------------------------------------------

# ----------------------------------------------------------------------
# PRE-CRS EXCLUSIONS (WordPress / Drupal / CiviCRM)
# ----------------------------------------------------------------------
Include /etc/nginx/modsec/REQUEST-900-EXCLUSIONS.conf

Include /etc/nginx/modsec/coreruleset-4.3.0/crs-setup.conf

# Maintain your anomaly settings
SecAction "id:900110,phase:1,pass,nolog,\
  setvar:tx.inbound_anomaly_score_threshold=5,\
  setvar:tx.outbound_anomaly_score_threshold=5"

# PL1
SecAction "id:900000,phase:1,pass,nolog,\
  setvar:tx.paranoia_level=1"

# ----------------------------------------------------------------------
# CRS 4.x RULESET
# ----------------------------------------------------------------------
Include /etc/nginx/modsec/coreruleset-4.3.0/rules/*.conf

# ----------------------------------------------------------------------
# POST-CRS EXCLUSIONS
# ----------------------------------------------------------------------
Include /etc/nginx/modsec/RESPONSE-999-EXCLUSIONS-AFTER-CRS.conf

# Your whitelist rules
Include /etc/nginx/modsec/whitelist/whitelist.conf

# Test rule
SecRule ARGS:testparam "@contains pinkyandthebrain" \
    "id:1234,deny,status:403"
